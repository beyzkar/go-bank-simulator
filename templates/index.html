<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Go Bank Simulator</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">
<div class="container py-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h3">Go Bank Simulator</h1>
    <button class="btn btn-outline-primary" onclick="loadAll()">Yenile</button>
  </div>

  <!-- ðŸ” MÃ¼ÅŸteri Arama -->
  <div class="card mb-3">
    <div class="card-body">
      <h5>Ä°simle MÃ¼ÅŸteri Ara</h5>
      <div class="input-group">
        <input id="searchName" class="form-control" placeholder="Ä°sim yaz">
        <button class="btn btn-primary" onclick="searchCustomer()">Ara</button>
      </div>
      <div id="searchResult" class="mt-3"></div>
      <div id="accounts" class="mt-3"></div>
    </div>
  </div>

  <!-- ðŸ‘¥ MÃ¼ÅŸteriler -->
  <div class="card mb-3">
    <div class="card-body">
      <h5>MÃ¼ÅŸteriler</h5>

      <form class="row g-2 mb-3" onsubmit="createCustomer(event)">
        <div class="col-md-3">
          <input id="custName" class="form-control" placeholder="Ad Soyad" required>
        </div>
        <div class="col-md-3">
          <input id="custEmail" class="form-control" placeholder="Email" type="email" required>
        </div>

        <!-- âœ… YENÄ°: BaÅŸlangÄ±Ã§ bakiyesi -->
        <div class="col-md-3">
          <input id="custBalance" class="form-control" placeholder="BaÅŸlangÄ±Ã§ Bakiye (â‚º)" type="number" min="0" step="0.01" required>
        </div>

        <div class="col-md-3 d-grid">
          <button class="btn btn-success">Ekle</button>
        </div>
      </form>

      <table class="table table-sm">
        <thead>
          <tr><th>ID</th><th>Ä°sim</th><th>Email</th><th></th></tr>
        </thead>
        <tbody id="customersBody"></tbody>
      </table>
    </div>
  </div>

  <!-- ðŸ’³ Hesap Sorgu + Para Ä°ÅŸlemleri -->
  <div class="card mb-3">
    <div class="card-body">
      <h5>Hesap Ä°ÅŸlemleri</h5>

      <!-- âœ… ARTIK CUSTOMER ID -->
      <form class="row g-2 mb-3" onsubmit="getAccount(event)">
        <div class="col-md-6">
          <input id="custIdForOps" class="form-control" placeholder="Customer ID" type="number" min="1" required>
        </div>
        <div class="col-md-6 d-grid">
          <button class="btn btn-dark">HesabÄ± Getir</button>
        </div>
      </form>

      <div id="accountCard"></div>

      <div class="row g-2 mt-3">
        <div class="col-md-4">
          <input id="moneyAmount" class="form-control" placeholder="Tutar" type="number" min="0.01" step="0.01">
        </div>
        <div class="col-md-4 d-grid">
          <!-- âœ… type=button Ã¶nemli -->
          <button type="button" class="btn btn-success" onclick="deposit()">Para YatÄ±r</button>
        </div>
        <div class="col-md-4 d-grid">
          <!-- âœ… type=button Ã¶nemli -->
          <button type="button" class="btn btn-danger" onclick="withdraw()">Para Ã‡ek</button>
        </div>
      </div>

      <div id="opMsg" class="mt-3"></div>
    </div>
  </div>

  <!-- ðŸ” MÃ¼ÅŸteriler ArasÄ± Transfer (CustomerID ile) -->
  <div class="card mb-3">
    <div class="card-body">
      <h5>MÃ¼ÅŸteriler ArasÄ± Transfer</h5>

      <div class="row g-2">
        <div class="col-md-4">
          <input id="fromCustomerId" class="form-control" placeholder="GÃ¶nderen Customer ID" type="number" min="1">
        </div>
        <div class="col-md-4">
          <input id="toCustomerId" class="form-control" placeholder="Alan Customer ID" type="number" min="1">
        </div>
        <div class="col-md-4">
          <input id="transferAmount" class="form-control" placeholder="Tutar" type="number" min="0.01" step="0.01">
        </div>
      </div>

      <div class="d-grid mt-3">
        <button type="button" class="btn btn-warning" onclick="transferByCustomer()">
          Transfer Yap
        </button>
      </div>

      <div id="transferMsg" class="mt-3"></div>
    </div>
  </div>

</div>

<script>
const api = (url, opts={}) => fetch(url, {
  headers: {"Content-Type":"application/json"},
  ...opts
});

function showOpMsg(text, ok=true){
  const el = document.getElementById("opMsg");
  el.innerHTML = `<div class="alert ${ok ? "alert-success" : "alert-danger"} mb-0">${text}</div>`;
}

function clearOpMsg(){
  document.getElementById("opMsg").innerHTML = "";
}

function showTransferMsg(text, ok=true){
  const el = document.getElementById("transferMsg");
  el.innerHTML = `<div class="alert ${ok ? "alert-success" : "alert-danger"} mb-0">${text}</div>`;
}

function clearTransferMsg(){
  document.getElementById("transferMsg").innerHTML = "";
}

async function loadCustomers(){
  const r = await api("/customers");
  const data = await r.json();
  const body = document.getElementById("customersBody");
  body.innerHTML = "";
  data.forEach(c => {
    body.innerHTML += `
      <tr>
        <td>${c.ID}</td>
        <td>${c.Name}</td>
        <td>${c.Email}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-danger"
            onclick="deleteCustomer(${c.ID}, '${String(c.Name).replace(/'/g,"\\'")}')">Sil</button>
        </td>
      </tr>`;
  });
}

async function createCustomer(e){
  e.preventDefault();
  clearOpMsg();

  const name = document.getElementById("custName").value;
  const email = document.getElementById("custEmail").value;
  const balance = Number(document.getElementById("custBalance").value);

  const res = await api("/customers", {
    method:"POST",
    body: JSON.stringify({ name, email, balance })
  });

  const data = await res.json().catch(()=> ({}));
  if(!res.ok){
    showOpMsg(data.error || "MÃ¼ÅŸteri eklenemedi", false);
    return;
  }

  e.target.reset();
  showOpMsg("MÃ¼ÅŸteri eklendi âœ…");
  loadCustomers();
}

async function deleteCustomer(id, name){
  const ok = confirm(`${name} (ID:${id}) silinsin mi?`);
  if(!ok) return;

  clearOpMsg();
  const res = await api(`/customers/${id}`, {method:"DELETE"});
  if(!res.ok){
    const data = await res.json().catch(()=> ({}));
    showOpMsg(data.error || "Silme baÅŸarÄ±sÄ±z", false);
    return;
  }

  showOpMsg("MÃ¼ÅŸteri silindi âœ…");
  loadCustomers();
}

async function searchCustomer(){
  clearOpMsg();
  const q = document.getElementById("searchName").value.trim();
  if(!q){
    document.getElementById("searchResult").innerHTML = `<div class="text-muted">Ä°sim yaz.</div>`;
    return;
  }

  let res = await api(`/customers/search?q=${encodeURIComponent(q)}`);
  let found = await res.json().catch(()=> []);

  if(!res.ok){
    const r2 = await api("/customers");
    const all = await r2.json().catch(()=> []);
    found = all.filter(c => (c.Name || "").toLowerCase().includes(q.toLowerCase()));
  }

  if(!found || found.length === 0){
    document.getElementById("searchResult").innerHTML =
      `<div class="alert alert-warning mb-0">SonuÃ§ bulunamadÄ±.</div>`;
    document.getElementById("accounts").innerHTML = "";
    return;
  }

  document.getElementById("searchResult").innerHTML = found.map(c =>
    `<div class="alert alert-info d-flex justify-content-between align-items-center">
      <div>
        <b>${c.Name}</b> â€“ ${c.Email} (ID: ${c.ID})
      </div>
      <button class="btn btn-sm btn-outline-primary" onclick="loadAccounts(${c.ID}, '${String(c.Name).replace(/'/g,"\\'")}')">HesabÄ± GÃ¶ster</button>
    </div>`
  ).join("");
}

async function loadAccounts(customerId, customerName){
  const res = await api(`/customers/${customerId}/accounts`);
  const accounts = await res.json().catch(()=> []);

  if(!res.ok){
    document.getElementById("accounts").innerHTML = `<div class="text-danger">Hesaplar getirilemedi.</div>`;
    return;
  }
  if(!accounts || accounts.length === 0){
    document.getElementById("accounts").innerHTML =
      `<div class="alert alert-secondary mb-0">${customerName} iÃ§in hesap yok.</div>`;
    return;
  }

  let html = `<div class="fw-bold mb-2">${customerName} HesabÄ±</div>`;
  for(const a of accounts){
    const accId = a.ID;
    const dres = await api(`/accounts/${accId}/details`);
    const d = await dres.json().catch(()=> ({}));

    if(dres.ok){
      html += `
        <div class="bg-dark text-white p-3 rounded mb-2">
          <div class="fw-bold">${d.customerName}</div>
          <div><b>Account ID:</b> ${d.accountId}</div>
          <div><b>Customer ID:</b> ${d.customerId}</div>
          <div><b>Bakiye:</b> ${d.balance} â‚º</div>
          <div class="mt-1"><b>Son Ä°ÅŸlem:</b> ${d.lastAction}</div>
          <button class="btn btn-sm btn-outline-light mt-2" onclick="fillAccountFromAccountId(${d.accountId})">Bu hesabÄ± seÃ§</button>
        </div>
      `;
    } else {
      html += `<div class="alert alert-danger">Account ${accId} detaylarÄ± alÄ±namadÄ±.</div>`;
    }
  }

  document.getElementById("accounts").innerHTML = html;
}

/**
 * Bu fonksiyon, kullanÄ±cÄ± hesap kartÄ±ndan bir account seÃ§ince:
 * - O accountId'yi currentAccountId yapar
 * - details Ã§ekip accountCard'a yazar
 */
async function fillAccountFromAccountId(accountId){
  clearOpMsg();
  currentAccountId = Number(accountId);

  const r = await api(`/accounts/${currentAccountId}/details`);
  const d = await r.json().catch(()=> ({}));

  if(!r.ok){
    showOpMsg(d.error || "Hesap bulunamadÄ±", false);
    document.getElementById("accountCard").innerHTML = "";
    return;
  }

  renderAccountCard(d);
}

// âœ… ArtÄ±k tek kaynak: currentAccountId (deposit/withdraw bununla Ã§alÄ±ÅŸÄ±r)
let currentAccountId = null;

// âœ… Customer ID ile hesabÄ± getir (ilk hesabÄ± seÃ§er)
async function getAccount(e){
  e.preventDefault();
  clearOpMsg();

  const customerId = Number(document.getElementById("custIdForOps").value);
  if(!Number.isFinite(customerId) || customerId <= 0){
    showOpMsg("GeÃ§erli bir Customer ID gir.", false);
    return;
  }

  // 1) mÃ¼ÅŸterinin hesaplarÄ±nÄ± al
  const ares = await api(`/customers/${customerId}/accounts`);
  const accounts = await ares.json().catch(()=> []);

  if(!ares.ok){
    showOpMsg((accounts && accounts.error) ? accounts.error : "Hesaplar getirilemedi", false);
    document.getElementById("accountCard").innerHTML = "";
    currentAccountId = null;
    return;
  }

  if(!accounts || accounts.length === 0){
    showOpMsg("Bu mÃ¼ÅŸteri iÃ§in hesap bulunamadÄ±", false);
    document.getElementById("accountCard").innerHTML = "";
    currentAccountId = null;
    return;
  }

  // 2) ilk accountId
  const firstAccId = Number(accounts[0].ID);
  currentAccountId = firstAccId;

  // 3) details
  await refreshCurrentAccountDetails();
}

function renderAccountCard(d){
  document.getElementById("accountCard").innerHTML = `
    <div class="card bg-dark text-white">
      <div class="card-body">
        <h5 class="mb-3">${d.customerName}</h5>
        <p class="mb-1"><b>Account ID:</b> ${d.accountId}</p>
        <p class="mb-1"><b>Customer ID:</b> ${d.customerId}</p>
        <p class="mb-2"><b>Bakiye:</b> ${d.balance} â‚º</p>
        <p class="mb-0"><b>Son Ä°ÅŸlem:</b> ${d.lastAction}</p>
      </div>
    </div>`;
}

async function refreshCurrentAccountDetails(){
  if(!currentAccountId){
    document.getElementById("accountCard").innerHTML = "";
    return;
  }

  const r = await api(`/accounts/${currentAccountId}/details`);
  const d = await r.json().catch(()=> ({}));

  if(!r.ok){
    showOpMsg(d.error || "Hesap bulunamadÄ±", false);
    document.getElementById("accountCard").innerHTML = "";
    return;
  }

  renderAccountCard(d);
}

async function deposit(){
  clearOpMsg();
  if(!currentAccountId){
    showOpMsg("Ã–nce bir mÃ¼ÅŸteri ID ile hesabÄ± getir.", false);
    return;
  }

  const amount = Number(document.getElementById("moneyAmount").value);
  if(!Number.isFinite(amount) || amount <= 0){
    showOpMsg("GeÃ§erli bir tutar gir.", false);
    return;
  }

  const res = await api(`/accounts/${currentAccountId}/deposit`, {
    method:"POST",
    body: JSON.stringify({ amount })
  });
  const data = await res.json().catch(()=> ({}));

  if(!res.ok){
    showOpMsg(data.error || "Para yatÄ±rma baÅŸarÄ±sÄ±z", false);
    return;
  }

  showOpMsg("Para yatÄ±rÄ±ldÄ± âœ…");
  document.getElementById("moneyAmount").value = "";
  await refreshCurrentAccountDetails();
}

async function withdraw(){
  clearOpMsg();
  if(!currentAccountId){
    showOpMsg("Ã–nce bir mÃ¼ÅŸteri ID ile hesabÄ± getir.", false);
    return;
  }

  const amount = Number(document.getElementById("moneyAmount").value);
  if(!Number.isFinite(amount) || amount <= 0){
    showOpMsg("GeÃ§erli bir tutar gir.", false);
    return;
  }

  const res = await api(`/accounts/${currentAccountId}/withdraw`, {
    method:"POST",
    body: JSON.stringify({ amount })
  });
  const data = await res.json().catch(()=> ({}));

  if(!res.ok){
    showOpMsg(data.error || "Para Ã§ekme baÅŸarÄ±sÄ±z", false);
    return;
  }

  showOpMsg("Para Ã§ekildi âœ…");
  document.getElementById("moneyAmount").value = "";
  await refreshCurrentAccountDetails();
}

/* âœ… YENÄ°: CustomerID ile transfer */
async function transferByCustomer(){
  clearTransferMsg();

  const fromCustomerId = Number(document.getElementById("fromCustomerId").value);
  const toCustomerId = Number(document.getElementById("toCustomerId").value);
  const amount = Number(document.getElementById("transferAmount").value);

  if(!Number.isFinite(fromCustomerId) || fromCustomerId <= 0 ||
     !Number.isFinite(toCustomerId) || toCustomerId <= 0 ||
     !Number.isFinite(amount) || amount <= 0){
    showTransferMsg("LÃ¼tfen alanlarÄ± doÄŸru doldur.", false);
    return;
  }

  const res = await api("/transfer/by-customer", {
    method: "POST",
    body: JSON.stringify({
      fromCustomerId,
      toCustomerId,
      amount
    })
  });

  const data = await res.json().catch(()=> ({}));

  if(!res.ok){
    showTransferMsg(data.error || "Transfer baÅŸarÄ±sÄ±z", false);
    return;
  }

  showTransferMsg("Transfer baÅŸarÄ±lÄ± âœ…");
  // Ä°stersen gÃ¶ndericinin hesabÄ±nÄ± otomatik yenileyelim:
  // document.getElementById("custIdForOps").value = fromCustomerId;
  // getAccount(new Event("submit"));
}

async function loadAll(){
  await loadCustomers();
}
loadAll();
</script>
</body>
</html>
